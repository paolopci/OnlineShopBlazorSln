@page "/products/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.IO
@using System.Linq
@using System.Text.Json
@inject IDbContextFactory<OnlineShopBlazor.Models.Db.OnLineShopContext> DbFactory
@inject IWebHostEnvironment Environment
@inject NavigationManager NavigationManager

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>

<h2>Product</h2>
<hr />
@if (Product is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <EditForm Model="Product" OnValidSubmit="UpdateProduct" FormName="edit" enctype="multipart/form-data">
                <DataAnnotationsValidator />
                <ValidationSummary role="alert" />
                @if (!string.IsNullOrEmpty(UploadError))
                {
                    <div class="alert alert-danger">@UploadError</div>
                }
                <input type="hidden" name="Product.Id" value="@Product.Id" />
                <div class="mb-3">
                    <label for="title" class="form-label">Title:</label>
                    <InputText id="title" @bind-Value="Product.Title" class="form-control" />
                    <ValidationMessage For="() => Product.Title" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <InputText id="description" @bind-Value="Product.Description" class="form-control" />
                    <ValidationMessage For="() => Product.Description" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="fulldesc" class="form-label">FullDesc:</label>
                    <div class="resizable-editor-wrapper">
                        <RadzenHtmlEditor id="fulldesc" class="form-control full-desc-editor" @bind-Value="Product.FullDesc"
                            Change="UpdateFullDescCount" Style="height: 350px" />
                    </div>
                    <div class="@($"small text-end {FullDescClass}")">@($"{FullDescCharacterCount}/{FullDescMaxLength}")
                    </div>
                    <ValidationMessage For="() => Product.FullDesc" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">Price:</label>
                    <InputNumber id="price" @bind-Value="Product.Price" class="form-control" />
                    <ValidationMessage For="() => Product.Price" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="discount" class="form-label">Discount:</label>
                    <InputNumber id="discount" @bind-Value="Product.Discount" class="form-control" />
                    <ValidationMessage For="() => Product.Discount" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="imagename" class="form-label">ImageName:</label>
                    <div class="primary-image-current">
                        @if (string.IsNullOrWhiteSpace(Product.ImageName))
                        {
                            <span class="text-muted">Nessuna immagine salvata</span>
                        }
                        else
                        {
                            <img src="@GetPrimaryImageUrl(Product.ImageName)" alt="Product image" class="primary-image-thumb" />
                        }
                    </div>
                    <div class="primary-image-input">
                        <InputFile id="imagename" OnChange="HandlePrimaryImageChange" class="primary-image-input__file" />
                    </div>
                    <ValidationMessage For="() => Product.ImageName" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Gallery Images:</label>
                    @if (GalleryImages.Count == 0)
                    {
                        <p class="text-muted">Nessuna immagine nella galleria.</p>
                    }
                    else
                    {
                        <div class="gallery-row">
                            @foreach (var gallery in GalleryImages)
                            {
                                <div class="gallery-item">
                                    <img src="@GetGalleryImageUrl(gallery.ImageName)" alt="Product image" class="gallery-thumb" />
                                    <div class="gallery-actions">
                                        <label class="btn btn-success gallery-action-btn" for="@($"gallery-upload-{gallery.Id}")"
                                            title="Sostituisci immagine">
                                            <i class="bi bi-cloud-upload-fill"></i>
                                            <span class="gallery-action-label">Edit</span>
                                        </label>
                                        <InputFile id="@($"gallery-upload-{gallery.Id}")" class="d-none"
                                            OnChange="args => ReplaceGalleryImageAsync(gallery.Id, args)" />
                                        <button type="button" class="btn btn-danger gallery-action-btn"
                                            @onclick="() => DeleteGalleryImageAsync(gallery.Id)" title="Elimina immagine">
                                            <i class="bi bi-trash-fill"></i>
                                            <span class="gallery-action-label">Delete</span>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(GalleryGlobalMessage))
                    {
                        <pre class="gallery-feedback mt-2">@GalleryGlobalMessage</pre>
                    }
                    <InputFile id="galleryFileInput" class="form-control mt-2" OnChange="AddGalleryImageAsync" multiple />
                </div>
                <div class="mb-3">
                    <label for="qty" class="form-label">Qty:</label>
                    <InputNumber id="qty" @bind-Value="Product.Qty" class="form-control" />
                    <ValidationMessage For="() => Product.Qty" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags:</label>
                    <InputText id="tags" @bind-Value="Product.Tags" class="form-control" />
                    <ValidationMessage For="() => Product.Tags" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="videourl" class="form-label">VideoUrl:</label>
                    <InputText id="videourl" @bind-Value="Product.VideoUrl" class="form-control" />
                    <ValidationMessage For="() => Product.VideoUrl" class="text-danger" />
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/products">Back to List</a>
</div>
<Preload />

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Product? Product { get; set; }
    [Inject]
    protected PreloadService PreloadService { get; set; } = default!;

    private List<ProductGallery> GalleryImages { get; set; } = new();
    private IBrowserFile? PrimaryImageFile;
    private readonly List<GalleryUpload> GalleryUploads = new();
    private Dictionary<int, string> GalleryActionMessages { get; } = new();
    private string? GalleryGlobalMessage { get; set; }

    private bool ReplaceGalleryRequested { get; set; }
    private string? OriginalImageName { get; set; }
    private string? UploadError { get; set; }

    private const long MaxUploadSize = 1024 * 1024 * 5;
    private const int FullDescMaxLength = 4000;

    private int FullDescCharacterCount { get; set; }
    private string FullDescClass => FullDescCharacterCount > FullDescMaxLength ? "text-danger" : "text-muted";

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Product ??= await context.Products.FirstOrDefaultAsync(m => m.Id == Id);
        GalleryImages = await context.ProductGalleries.Where(g => g.ProductId == Id).ToListAsync();
        OrderGalleryImages();
        OriginalImageName = Product?.ImageName;

        if (Product is null)
        {
            NavigationManager.NavigateTo("notfound");
        }

        FullDescCharacterCount = Product?.FullDesc?.Length ?? 0;
    }

    private async Task UpdateProduct()
    {
        // ------------------------------------------------------------------
        PreloadService.Show(SpinnerColor.Light, "Saving... Please Wait...");
        // ------------------------------------------------------------------
        UploadError = null;
        using var context = DbFactory.CreateDbContext();
        context.Attach(Product!).State = EntityState.Modified;

        await SavePrimaryImageAsync();

        try
        {
            if (ReplaceGalleryRequested && GalleryUploads.Count == 0)
            {
                UploadError = "Seleziona almeno un'immagine per sostituire la galleria.";
                return;
            }

            if (ReplaceGalleryRequested)
            {
                await ReplaceGalleryAsync(context);
            }

            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            // ------------------------------------------------------------------
            PreloadService.Hide();
            // ------------------------------------------------------------------
            if (!ProductExists(Product!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }
        catch (Exception ex)
        {
            UploadError = $"Errore durante l'aggiornamento: {ex.Message}";
            return;
        }
        // ------------------------------------------------------------------
        PreloadService.Hide();
        // ------------------------------------------------------------------
        NavigationManager.NavigateTo("/products");
    }

    private bool ProductExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Products.Any(e => e.Id == id);
    }

    private void HandlePrimaryImageChange(InputFileChangeEventArgs args)
    {
        if (Product is null)
        {
            return;
        }

        PrimaryImageFile = args.File;
        if (PrimaryImageFile is null)
        {
            Product.ImageName = null;
            return;
        }

        var extension = Path.GetExtension(PrimaryImageFile.Name);
        Product.ImageName = $"{Guid.NewGuid()}{extension}";
    }

    private async Task SavePrimaryImageAsync()
    {
        if (PrimaryImageFile is null || string.IsNullOrWhiteSpace(Product?.ImageName))
        {
            return;
        }

        var imagesDirectory = Path.Combine(Environment.WebRootPath, "images", "Products");
        if (!Directory.Exists(imagesDirectory))
        {
            Directory.CreateDirectory(imagesDirectory);
        }

        if (!string.IsNullOrWhiteSpace(OriginalImageName) && !string.Equals(OriginalImageName, Product.ImageName,
        StringComparison.OrdinalIgnoreCase))
        {
            var originalPath = Path.Combine(imagesDirectory, OriginalImageName);
            if (File.Exists(originalPath))
            {
                File.Delete(originalPath);
            }
        }

        var filePath = Path.Combine(imagesDirectory, Product!.ImageName);
        await using FileStream fs = new(filePath, FileMode.Create);
        await PrimaryImageFile.OpenReadStream(MaxUploadSize).CopyToAsync(fs);
        OriginalImageName = Product.ImageName;
    }

    private void HandleGalleryImagesChange(InputFileChangeEventArgs args)
    {
        GalleryUploads.Clear();
        foreach (var file in args.GetMultipleFiles())
        {
            var extension = Path.GetExtension(file.Name);
            var storedName = $"{Guid.NewGuid()}{extension}";
            GalleryUploads.Add(new GalleryUpload(file, storedName));
        }

        ReplaceGalleryRequested = GalleryUploads.Count > 0;
    }

    private async Task ReplaceGalleryAsync(OnLineShopContext context)
    {
        var existing = await context.ProductGalleries.Where(g => g.ProductId == Product!.Id).ToListAsync();
        if (existing.Count > 0)
        {
            context.ProductGalleries.RemoveRange(existing);

            foreach (var gallery in existing)
            {
                if (!string.IsNullOrWhiteSpace(gallery.ImageName))
                {
                    var existingPath = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery", gallery.ImageName);
                    if (File.Exists(existingPath))
                    {
                        File.Delete(existingPath);
                    }
                }
            }
        }

        if (GalleryUploads.Count == 0)
        {
            return;
        }

        var galleryDirectory = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery");
        if (!Directory.Exists(galleryDirectory))
        {
            Directory.CreateDirectory(galleryDirectory);
        }

        foreach (var upload in GalleryUploads)
        {
            var destination = Path.Combine(galleryDirectory, upload.StoredName);
            await using FileStream fs = new(destination, FileMode.Create);
            await upload.File.OpenReadStream(MaxUploadSize).CopyToAsync(fs);

            context.ProductGalleries.Add(new ProductGallery
            {
                ProductId = Product!.Id,
                ImageName = upload.StoredName
            });
        }
    }

    private async Task AddGalleryImageAsync(InputFileChangeEventArgs args)
    {
        GalleryGlobalMessage = null;
        if (args.FileCount == 0)
        {
            GalleryGlobalMessage = JsonSerializer.Serialize(new { status = "error", message = "Nessun file selezionato." });
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            foreach (var file in args.GetMultipleFiles())
            {
                var extension = Path.GetExtension(file.Name);
                var storedName = $"{Guid.NewGuid()}{extension}";

                var galleryDirectory = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery");
                if (!Directory.Exists(galleryDirectory))
                {
                    Directory.CreateDirectory(galleryDirectory);
                }

                var destination = Path.Combine(galleryDirectory, storedName);
                await using FileStream fs = new(destination, FileMode.Create);
                await file.OpenReadStream(MaxUploadSize).CopyToAsync(fs);

                context.ProductGalleries.Add(new ProductGallery
                {
                    ProductId = Product!.Id,
                    ImageName = storedName
                });
            }

            await context.SaveChangesAsync();
            await ReloadGalleryImagesAsync();
            GalleryGlobalMessage = JsonSerializer.Serialize(new { status = "success", message = "Image aggiunta correttamente." });
        }
        catch (Exception ex)
        {
            GalleryGlobalMessage = JsonSerializer.Serialize(new { status = "error", message = $"Errore durante l'upload: {ex.Message}" });
        }
    }

    private async Task ReplaceGalleryImageAsync(int galleryId, InputFileChangeEventArgs args)
    {
        GalleryGlobalMessage = null;
        if (args.FileCount == 0)
        {
            SetGalleryMessage(galleryId, "error", "Nessun file selezionato.");
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            var gallery = await context.ProductGalleries.FirstOrDefaultAsync(g => g.Id == galleryId && g.ProductId == Id);
            if (gallery is null)
            {
                SetGalleryMessage(galleryId, "error", "Immagine non trovata.");
                return;
            }

            var file = args.File;
            var extension = Path.GetExtension(file.Name);
            var storedName = $"{Guid.NewGuid()}{extension}";

            var galleryDirectory = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery");
            if (!Directory.Exists(galleryDirectory))
            {
                Directory.CreateDirectory(galleryDirectory);
            }

            if (!string.IsNullOrWhiteSpace(gallery.ImageName))
            {
                var existingPath = Path.Combine(galleryDirectory, gallery.ImageName);
                if (File.Exists(existingPath))
                {
                    File.Delete(existingPath);
                }
            }

            var destination = Path.Combine(galleryDirectory, storedName);
            await using FileStream fs = new(destination, FileMode.Create);
            await file.OpenReadStream(MaxUploadSize).CopyToAsync(fs);

            gallery.ImageName = storedName;
            await context.SaveChangesAsync();
            await ReloadGalleryImagesAsync();
            SetGalleryMessage(galleryId, "success", "Image uploaded successfully");
        }
        catch (Exception ex)
        {
            SetGalleryMessage(galleryId, "error", $"Errore durante l'upload: {ex.Message}");
        }
    }

    private async Task DeleteGalleryImageAsync(int galleryId)
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            var gallery = await context.ProductGalleries.FirstOrDefaultAsync(g => g.Id == galleryId && g.ProductId == Id);
            if (gallery is null)
            {
                SetGalleryMessage(galleryId, "error", "Immagine non trovata.");
                return;
            }

            if (!string.IsNullOrWhiteSpace(gallery.ImageName))
            {
                var path = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery", gallery.ImageName);
                if (File.Exists(path))
                {
                    File.Delete(path);
                }
            }

            context.ProductGalleries.Remove(gallery);
            await context.SaveChangesAsync();
            await ReloadGalleryImagesAsync();
            GalleryActionMessages.Remove(galleryId);
            GalleryGlobalMessage = JsonSerializer.Serialize(new { status = "success", message = "Image deleted successfully" });
        }
        catch (Exception ex)
        {
            GalleryGlobalMessage = JsonSerializer.Serialize(new { status = "error", message = $"Errore durante l'eliminazione: {ex.Message}" });
        }
    }

    private async Task ReloadGalleryImagesAsync()
    {
        using var context = DbFactory.CreateDbContext();
        GalleryImages = await context.ProductGalleries
        .Where(g => g.ProductId == Id)
        .ToListAsync();
        OrderGalleryImages();
    }

    private string GetGalleryImageUrl(string? imageName) =>
    string.IsNullOrWhiteSpace(imageName) ? string.Empty : $"/images/products/gallery/{imageName}";

    private string GetPrimaryImageUrl(string? imageName) =>
    string.IsNullOrWhiteSpace(imageName) ? string.Empty : $"/images/products/{imageName}";

    private void OrderGalleryImages()
    {
        GalleryImages = GalleryImages
        .OrderByDescending(g => GetGalleryTimestamp(g))
        .ToList();
    }

    private DateTime GetGalleryTimestamp(ProductGallery gallery)
    {
        if (string.IsNullOrWhiteSpace(gallery.ImageName))
        {
            return DateTime.MinValue;
        }

        var path = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery", gallery.ImageName);
        return File.Exists(path) ? File.GetCreationTimeUtc(path) : DateTime.MinValue;
    }

    private void SetGalleryMessage(int galleryId, string status, string message)
    {
        var json = JsonSerializer.Serialize(new { status, message });
        GalleryActionMessages[galleryId] = json;
    }

    private sealed class GalleryUpload
    {
        public GalleryUpload(IBrowserFile file, string storedName)
        {
            File = file;
            StoredName = storedName;
        }

        public IBrowserFile File { get; }
        public string StoredName { get; }
    }

    private void UpdateFullDescCount()
    {
        if (Product is null)
        {
            return;
        }

        FullDescCharacterCount = Product.FullDesc?.Length ?? 0;
    }
}