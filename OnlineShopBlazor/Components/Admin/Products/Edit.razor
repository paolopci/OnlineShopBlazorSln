@page "/products/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using System.IO
@inject IDbContextFactory<OnlineShopBlazor.Models.Db.OnLineShopContext> DbFactory
@inject IWebHostEnvironment Environment
@inject NavigationManager NavigationManager

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>

<h2>Product</h2>
<hr />
@if (Product is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <EditForm Model="Product" OnValidSubmit="UpdateProduct" FormName="edit" enctype="multipart/form-data">
                <DataAnnotationsValidator />
                <ValidationSummary role="alert" />
                @if (!string.IsNullOrEmpty(UploadError))
                {
                    <div class="alert alert-danger">@UploadError</div>
                }
                <input type="hidden" name="Product.Id" value="@Product.Id" />
                <div class="mb-3">
                    <label for="title" class="form-label">Title:</label>
                    <InputText id="title" @bind-Value="Product.Title" class="form-control" />
                    <ValidationMessage For="() => Product.Title" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <InputText id="description" @bind-Value="Product.Description" class="form-control" />
                    <ValidationMessage For="() => Product.Description" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="fulldesc" class="form-label">FullDesc:</label>
                    <RadzenHtmlEditor id="fulldesc" class="form-control" Style="min-height: 320px;"
                        @bind-Value="Product.FullDesc" Change="UpdateFullDescCount" />
                    <div class="@($"small text-end {FullDescClass}")">@($"{FullDescCharacterCount}/{FullDescMaxLength}")
                    </div>
                    <ValidationMessage For="() => Product.FullDesc" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="price" class="form-label">Price:</label>
                    <InputNumber id="price" @bind-Value="Product.Price" class="form-control" />
                    <ValidationMessage For="() => Product.Price" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="discount" class="form-label">Discount:</label>
                    <InputNumber id="discount" @bind-Value="Product.Discount" class="form-control" />
                    <ValidationMessage For="() => Product.Discount" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="imagename" class="form-label">ImageName:</label>
                    <div class="primary-image-current">
                        @(string.IsNullOrWhiteSpace(Product.ImageName) ? "Nessuna immagine salvata" : Product.ImageName)
                    </div>
                    <div class="primary-image-input">
                        <InputFile id="imagename" OnChange="HandlePrimaryImageChange" class="primary-image-input__file" />
                    </div>
                    <ValidationMessage For="() => Product.ImageName" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Gallery Images:</label>
                    @if (GalleryImages.Count == 0)
                    {
                        <p class="text-muted">Nessuna immagine nella galleria.</p>
                    }
                    else
                    {
                        <ul class="list-group mb-2">
                            @foreach (var gallery in GalleryImages)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@gallery.ImageName</span>
                                </li>
                            }
                        </ul>
                    }
                    <InputFile id="galleryFileInput" class="form-control" OnChange="HandleGalleryImagesChange" multiple />
                </div>
                <div class="mb-3">
                    <label for="qty" class="form-label">Qty:</label>
                    <InputNumber id="qty" @bind-Value="Product.Qty" class="form-control" />
                    <ValidationMessage For="() => Product.Qty" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags:</label>
                    <InputText id="tags" @bind-Value="Product.Tags" class="form-control" />
                    <ValidationMessage For="() => Product.Tags" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="videourl" class="form-label">VideoUrl:</label>
                    <InputText id="videourl" @bind-Value="Product.VideoUrl" class="form-control" />
                    <ValidationMessage For="() => Product.VideoUrl" class="text-danger" />
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/products">Back to List</a>
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Product? Product { get; set; }

    private List<ProductGallery> GalleryImages { get; set; } = new();
    private IBrowserFile? PrimaryImageFile;
    private readonly List<GalleryUpload> GalleryUploads = new();

    private bool ReplaceGalleryRequested { get; set; }
    private string? OriginalImageName { get; set; }
    private string? UploadError { get; set; }

    private const long MaxUploadSize = 1024 * 1024 * 5;
    private const int FullDescMaxLength = 4000;

    private int FullDescCharacterCount { get; set; }
    private string FullDescClass => FullDescCharacterCount > FullDescMaxLength ? "text-danger" : "text-muted";

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Product ??= await context.Products.FirstOrDefaultAsync(m => m.Id == Id);
        GalleryImages = await context.ProductGalleries.Where(g => g.ProductId == Id).ToListAsync();
        OriginalImageName = Product?.ImageName;

        if (Product is null)
        {
            NavigationManager.NavigateTo("notfound");
        }

        FullDescCharacterCount = Product?.FullDesc?.Length ?? 0;
    }

    private async Task UpdateProduct()
    {
        UploadError = null;
        using var context = DbFactory.CreateDbContext();
        context.Attach(Product!).State = EntityState.Modified;

        await SavePrimaryImageAsync();

        try
        {
            if (ReplaceGalleryRequested && GalleryUploads.Count == 0)
            {
                UploadError = "Seleziona almeno un'immagine per sostituire la galleria.";
                return;
            }

            if (ReplaceGalleryRequested)
            {
                await ReplaceGalleryAsync(context);
            }

            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!ProductExists(Product!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }
        catch (Exception ex)
        {
            UploadError = $"Errore durante l'aggiornamento: {ex.Message}";
            return;
        }

        NavigationManager.NavigateTo("/products");
    }

    private bool ProductExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Products.Any(e => e.Id == id);
    }

    private void HandlePrimaryImageChange(InputFileChangeEventArgs args)
    {
        if (Product is null)
        {
            return;
        }

        PrimaryImageFile = args.File;
        if (PrimaryImageFile is null)
        {
            Product.ImageName = null;
            return;
        }

        var extension = Path.GetExtension(PrimaryImageFile.Name);
        Product.ImageName = $"{Guid.NewGuid()}{extension}";
    }

    private async Task SavePrimaryImageAsync()
    {
        if (PrimaryImageFile is null || string.IsNullOrWhiteSpace(Product?.ImageName))
        {
            return;
        }

        var imagesDirectory = Path.Combine(Environment.WebRootPath, "images", "Products");
        if (!Directory.Exists(imagesDirectory))
        {
            Directory.CreateDirectory(imagesDirectory);
        }

        if (!string.IsNullOrWhiteSpace(OriginalImageName) && !string.Equals(OriginalImageName, Product.ImageName, StringComparison.OrdinalIgnoreCase))
        {
            var originalPath = Path.Combine(imagesDirectory, OriginalImageName);
            if (File.Exists(originalPath))
            {
                File.Delete(originalPath);
            }
        }

        var filePath = Path.Combine(imagesDirectory, Product!.ImageName);
        await using FileStream fs = new(filePath, FileMode.Create);
        await PrimaryImageFile.OpenReadStream(MaxUploadSize).CopyToAsync(fs);
        OriginalImageName = Product.ImageName;
    }

    private void HandleGalleryImagesChange(InputFileChangeEventArgs args)
    {
        GalleryUploads.Clear();
        foreach (var file in args.GetMultipleFiles())
        {
            var extension = Path.GetExtension(file.Name);
            var storedName = $"{Guid.NewGuid()}{extension}";
            GalleryUploads.Add(new GalleryUpload(file, storedName));
        }

        ReplaceGalleryRequested = GalleryUploads.Count > 0;
    }

    private async Task ReplaceGalleryAsync(OnLineShopContext context)
    {
        var existing = await context.ProductGalleries.Where(g => g.ProductId == Product!.Id).ToListAsync();
        if (existing.Count > 0)
        {
            context.ProductGalleries.RemoveRange(existing);

            foreach (var gallery in existing)
            {
                if (!string.IsNullOrWhiteSpace(gallery.ImageName))
                {
                    var existingPath = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery", gallery.ImageName);
                    if (File.Exists(existingPath))
                    {
                        File.Delete(existingPath);
                    }
                }
            }
        }

        if (GalleryUploads.Count == 0)
        {
            return;
        }

        var galleryDirectory = Path.Combine(Environment.WebRootPath, "images", "Products", "Gallery");
        if (!Directory.Exists(galleryDirectory))
        {
            Directory.CreateDirectory(galleryDirectory);
        }

        foreach (var upload in GalleryUploads)
        {
            var destination = Path.Combine(galleryDirectory, upload.StoredName);
            await using FileStream fs = new(destination, FileMode.Create);
            await upload.File.OpenReadStream(MaxUploadSize).CopyToAsync(fs);

            context.ProductGalleries.Add(new ProductGallery
            {
                ProductId = Product!.Id,
                ImageName = upload.StoredName
            });
        }
    }

    private sealed class GalleryUpload
    {
        public GalleryUpload(IBrowserFile file, string storedName)
        {
            File = file;
            StoredName = storedName;
        }

        public IBrowserFile File { get; }
        public string StoredName { get; }
    }

    private void UpdateFullDescCount()
    {
        if (Product is null)
        {
            return;
        }

        FullDescCharacterCount = Product.FullDesc?.Length ?? 0;
    }
}
